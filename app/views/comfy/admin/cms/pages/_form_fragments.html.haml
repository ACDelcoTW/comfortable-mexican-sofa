- begin
  - nodes = @page.fragment_nodes

  // Grouping nodes by their namespace
  - namespace = nodes.each_with_object({}) do |n, h|
    - h[n.namespace] ||= []
    - h[n.namespace] << n

  #form-fragments
    - if nodes.empty?
      .no-tags
        = link_to @page.layout.label, edit_comfy_admin_cms_site_layout_path(@site, @page.layout)
        = t(".no_tags").html_safe

    - else
      = fields_for :fragments, nil, builder: ComfortableMexicanSofa::FormBuilder, layout: :horizontal do |fragments|

        .tabbable
          - if namespace.size > 1
            %ul.nav.nav-tabs
              - namespace.each_with_index do |(name, tags), index|
                %li{class: index == 0 ? "active" : nil}
                  = link_to name.humanize, "#ns-#{name}", data: {toggle: "tab"}

          .tab-content
            - frag_index = 0
            - namespace.each_with_index do |(name, tags), index|
              .tab-pane{id: "ns-#{name}", class: index == 0 ? "active" : nil}
                - tags.each_with_index do |tag, index|
                  = fragments.field(tag, index)
- rescue
  - Rails.env.production?? nil : raise
